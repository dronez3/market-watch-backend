<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Market Watch â€” Scorecard</title>
  <style>
    :root { --bg:#0b1020; --card:#151b2e; --text:#e7ecf5; --muted:#9fb0d1; --accent:#5ee6a8; --warn:#ffc65c; --bad:#ff7a7a; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; background: var(--bg); color: var(--text); }
    header { padding: 20px 16px; border-bottom: 1px solid #20263f; background: #0e1430; position: sticky; top:0; z-index: 10; }
    h1 { margin:0; font-size: 20px; letter-spacing: .3px; }
    .wrap { max-width: 960px; margin: 0 auto; padding: 20px 16px; }
    .card { background: var(--card); border: 1px solid #232a44; border-radius: 14px; padding: 16px; box-shadow: 0 6px 24px rgba(0,0,0,.25); }
    .row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
    .row-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .row-1 { display: grid; grid-template-columns: 1fr; gap: 12px; }
    label { font-size: 12px; color: var(--muted); display:block; margin-bottom: 6px; }
    input, select, button { width:100%; padding: 10px 12px; border-radius: 10px; border: 1px solid #2a3356; background: #0f1533; color: var(--text); }
    input::placeholder { color:#7381a8; }
    button { cursor: pointer; border-color:#38406b; font-weight: 600; }
    button.primary { background: linear-gradient(180deg,#2cd4ff,#6cf3c5); color:#0a0f22; border: none; }
    button.ghost { background: transparent; }
    .pill { display:inline-flex; align-items:center; padding: 4px 8px; border-radius: 999px; font-size: 12px; border: 1px solid #2a3356; }
    .pill.ok { background: rgba(94,230,168,.12); border-color: rgba(94,230,168,.4); color: var(--accent); }
    .pill.warn { background: rgba(255,198,92,.12); border-color: rgba(255,198,92,.4); color: var(--warn); }
    .pill.bad { background: rgba(255,122,122,.12); border-color: rgba(255,122,122,.4); color: var(--bad); }
    .muted { color: var(--muted); }
    .grid { display:grid; gap:12px; }
    .kpi { display:grid; gap:6px; padding:10px; background:#101737; border:1px solid #263059; border-radius:12px; }
    .kpi .label { font-size:12px; color:var(--muted); }
    .kpi .value { font-size:18px; font-weight:700; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
    .footer { margin-top: 12px; font-size: 12px; color:var(--muted); }
    .hr { height:1px; background:#222a48; margin:12px 0; }
    .hidden { display:none; }
    .log pre { margin:0; white-space:pre-wrap; word-break:break-word; font-size:12px; color:#a7b6d6; }
    @media (max-width: 820px) {
      .row, .row-2 { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap" style="display:flex; align-items:center; gap:10px; justify-content:space-between;">
      <h1>ðŸ“Š Market Watch â€” Scorecard</h1>
      <a class="pill muted" href="/api/ping" target="_blank" style="text-decoration:none;">API Ping</a>
    </div>
  </header>

  <div class="wrap">
    <div class="card grid">
      <div class="row">
        <div>
          <label>Symbol</label>
          <input id="symbol" placeholder="e.g., AAPL" value="AAPL" />
        </div>
        <div>
          <label>Horizon (days)</label>
          <input id="horizon" type="number" min="1" max="14" value="5" />
        </div>
        <div>
          <label>Window (hours) for sentiment</label>
          <input id="hours" type="number" min="6" max="168" value="72" />
        </div>
      </div>
      <div class="row-2">
        <button class="primary" id="run">Run Scorecard</button>
        <button class="ghost" id="copyLink">Copy Shareable Link</button>
      </div>
      <div id="status" class="muted">Ready.</div>
    </div>

    <div id="result" class="grid hidden" style="margin-top:16px;">
      <div class="card">
        <div id="headline" style="font-size:16px; font-weight:700; margin-bottom:6px;">â€”</div>
        <div id="analysis" class="muted">â€”</div>
        <div class="hr"></div>
        <div class="row">
          <div class="kpi"><div class="label">Probability (base)</div><div class="value" id="pBase">â€”</div></div>
          <div class="kpi"><div class="label">Probability (blended)</div><div class="value" id="pBlend">â€”</div></div>
          <div class="kpi"><div class="label">Action</div><div class="value" id="action">â€”</div></div>
        </div>
      </div>

      <div class="row-2">
        <div class="card grid">
          <div style="display:flex; align-items:center; gap:8px; justify-content:space-between;">
            <div style="font-weight:700;">Technicals</div>
            <span id="techPill" class="pill">â€”</span>
          </div>
          <div class="row">
            <div class="kpi"><div class="label">RSI</div><div class="value" id="rsi">â€”</div></div>
            <div class="kpi"><div class="label">SMA50</div><div class="value" id="sma50">â€”</div></div>
            <div class="kpi"><div class="label">SMA200</div><div class="value" id="sma200">â€”</div></div>
          </div>
          <div class="footer mono muted" id="techNote"></div>
        </div>

        <div class="card grid">
          <div style="font-weight:700; display:flex; align-items:center; justify-content:space-between;">
            <span>Flows</span>
            <div style="display:flex; gap:8px;">
              <span id="optPill" class="pill">Options â€”</span>
              <span id="instPill" class="pill">Institutional â€”</span>
            </div>
          </div>
          <div class="row">
            <div class="kpi"><div class="label">Options tilt</div><div class="value" id="optTilt">â€”</div></div>
            <div class="kpi"><div class="label">Institutional tilt</div><div class="value" id="instTilt">â€”</div></div>
            <div class="kpi"><div class="label">7-bar momentum</div><div class="value" id="mom7">â€”</div></div>
          </div>
          <div class="footer mono muted" id="flowNote"></div>
        </div>
      </div>

      <div class="card log">
        <div style="font-weight:700; margin-bottom:6px;">Debug (fetched components)</div>
        <pre id="debug">â€”</pre>
      </div>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);
    const fmtPct = (x) => (x == null || isNaN(x)) ? "â€”" : (Number(x) * 100).toFixed(0) + "%";
    const fmtPct2 = (x) => (x == null || isNaN(x)) ? "â€”" : Number(x).toFixed(2) + "%";

    function setPill(el, label, kind="") {
      el.textContent = label;
      el.classList.remove("ok","warn","bad");
      if (kind) el.classList.add(kind);
    }

    async function run() {
      const sym = $("symbol").value.trim().toUpperCase();
      const horizon = Number($("horizon").value || 5);
      const hours = Number($("hours").value || 72);
      if (!sym) { alert("Enter a symbol"); return; }

      $("status").textContent = "Runningâ€¦";
      $("result").classList.add("hidden");

      const origin = location.origin;
      const url = `${origin}/api/scorecard_proxy?symbol=${encodeURIComponent(sym)}&horizon_days=${horizon}&hours=${hours}`;

      try {
        const r = await fetch(url, { cache: "no-store" });
        const data = await r.json();
        $("status").textContent = r.ok ? "Done." : `Error: ${r.status}`;
        $("debug").textContent = JSON.stringify(data, null, 2);

        if (!r.ok || !data || data.ok !== true) {
          $("result").classList.remove("hidden");
          $("headline").textContent = `${sym} â€” error`;
          $("analysis").textContent = (data && data.error) ? data.error : "Request failed";
          return;
        }

        $("result").classList.remove("hidden");
        $("headline").textContent = `${sym} â€” ${(data.probability_blended*100).toFixed(0)}% Upside (Blended)`;
        $("analysis").textContent = data.analysis || "â€”";

        $("pBase").textContent  = fmtPct(data.probability_base);
        $("pBlend").textContent = fmtPct(data.probability_blended);
        $("action").textContent = (data.action || "â€”").replace("_"," ");

        const rsi = data.technicals?.rsi ?? null;
        const sma50 = data.technicals?.sma50 ?? null;
        const sma200 = data.technicals?.sma200 ?? null;
        $("rsi").textContent = rsi == null ? "â€”" : Math.round(rsi);
        $("sma50").textContent = sma50 == null ? "â€”" : Math.round(sma50);
        $("sma200").textContent = sma200 == null ? "â€”" : Math.round(sma200);

        // Pill logic
        if (rsi == null || sma50 == null || sma200 == null) setPill($("techPill"), "Technicals â€” missing", "warn");
        else if (sma50 > sma200) setPill($("techPill"), "Technicals â€” uptrend", "ok");
        else if (sma50 < sma200) setPill($("techPill"), "Technicals â€” downtrend", "bad");
        else setPill($("techPill"), "Technicals â€” neutral", "warn");

        const probSignals = data.components?.prob?.data?.signals || {};
        $("mom7").textContent = fmtPct2(probSignals.pct_change_7);

        const opt = data.components?.options?.data;
        if (opt && opt.ok && opt.found !== false) {
          $("optTilt").textContent = (opt.label || "â€”") + ` (${Number(opt.tilt).toFixed(2)})`;
          setPill($("optPill"), `Options ${opt.label}`, opt.label === "bullish" ? "ok" : opt.label === "bearish" ? "bad" : "warn");
        } else {
          $("optTilt").textContent = "â€”";
          setPill($("optPill"), "Options â€” n/a", "warn");
        }

        const inst = data.components?.institutional?.data;
        if (inst && inst.ok && inst.found !== false) {
          $("instTilt").textContent = (inst.label || "â€”") + ` (${Number(inst.tilt).toFixed(2)})`;
          setPill($("instPill"), `Institutional ${inst.label}`, inst.label === "bullish" ? "ok" : inst.label === "bearish" ? "bad" : "warn");
        } else {
          $("instTilt").textContent = "â€”";
          setPill($("instPill"), "Institutional â€” n/a", "warn");
        }

        $("techNote").textContent = `SMA50 ${sma50 ?? "â€”"} vs SMA200 ${sma200 ?? "â€”"} â€¢ RSI ${rsi ?? "â€”"}`;
        $("flowNote").textContent = `7-bar momentum: ${$("mom7").textContent}`;

      } catch (e) {
        $("status").textContent = "Failed.";
        $("result").classList.remove("hidden");
        $("headline").textContent = "Error";
        $("analysis").textContent = String(e);
        $("debug").textContent = String(e);
      }
    }

    $("run").addEventListener("click", run);
    $("copyLink").addEventListener("click", () => {
      const sym = $("symbol").value.trim().toUpperCase() || "AAPL";
      const horizon = Number($("horizon").value || 5);
      const hours = Number($("hours").value || 72);
      const link = `${location.origin}/api/scorecard_proxy?symbol=${encodeURIComponent(sym)}&horizon_days=${horizon}&hours=${hours}`;
      navigator.clipboard.writeText(link).then(() => {
        $("status").textContent = "Copied shareable API link to clipboard.";
      });
    });

    // Auto-run if ?symbol= is present
    (function initFromQuery(){
      const q = new URLSearchParams(location.search);
      const sym = (q.get("symbol") || "").toUpperCase();
      if (sym) {
        $("symbol").value = sym;
        if (q.get("horizon_days")) $("horizon").value = q.get("horizon_days");
        if (q.get("hours")) $("hours").value = q.get("hours");
        run();
      }
    })();
  </script>
</body>
</html>
