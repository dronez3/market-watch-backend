<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Market Watch â€” Compare</title>
  <style>
    :root { --bg:#0b1020; --card:#151b2e; --text:#e7ecf5; --muted:#9fb0d1; --accent:#5ee6a8; --warn:#ffc65c; --bad:#ff7a7a; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; background: var(--bg); color: var(--text); }
    header { padding: 20px 16px; border-bottom: 1px solid #20263f; background: #0e1430; position: sticky; top:0; z-index: 10; }
    h1 { margin:0; font-size: 20px; letter-spacing: .3px; }
    .wrap { max-width: 1100px; margin: 0 auto; padding: 20px 16px; }
    .card { background: var(--card); border: 1px solid #232a44; border-radius: 14px; padding: 16px; box-shadow: 0 6px 24px rgba(0,0,0,.25); }
    label { font-size: 12px; color: var(--muted); display:block; margin-bottom: 6px; }
    input, button { width:100%; padding: 10px 12px; border-radius: 10px; border: 1px solid #2a3356; background: #0f1533; color: var(--text); }
    input::placeholder { color:#7381a8; }
    button { cursor: pointer; border-color:#38406b; font-weight: 600; }
    button.primary { background: linear-gradient(180deg,#2cd4ff,#6cf3c5); color:#0a0f22; border: none; }
    button.ghost { background: transparent; }
    .row { display: grid; grid-template-columns: 1fr 160px 160px; gap: 12px; }
    .pill { display:inline-flex; align-items:center; padding: 4px 8px; border-radius: 999px; font-size: 12px; border: 1px solid #2a3356; }
    .pill.ok { background: rgba(94,230,168,.12); border-color: rgba(94,230,168,.4); color: var(--accent); }
    .pill.warn { background: rgba(255,198,92,.12); border-color: rgba(255,198,92,.4); color: var(--warn); }
    .pill.bad { background: rgba(255,122,122,.12); border-color: rgba(255,122,122,.4); color: var(--bad); }
    table { width:100%; border-collapse: collapse; }
    th, td { padding: 10px; border-bottom: 1px solid #222a48; text-align: left; font-size: 14px; }
    th { color: var(--muted); user-select: none; cursor: pointer; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
    .muted { color: var(--muted); }
    .hr { height:1px; background:#222a48; margin:12px 0; }
    .hidden { display:none; }
    @media (max-width: 900px) {
      .row { grid-template-columns: 1fr; }
      th:nth-child(6), td:nth-child(6), th:nth-child(8), td:nth-child(8) { display:none; }
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap" style="display:flex; align-items:center; gap:10px; justify-content:space-between;">
      <h1>ðŸ“Š Market Watch â€” Compare</h1>
      <div style="display:flex; gap:8px;">
        <a class="pill muted" href="/scorecard.html" style="text-decoration:none;">Scorecard</a>
        <a class="pill muted" href="/api/ping" target="_blank" style="text-decoration:none;">API Ping</a>
      </div>
    </div>
  </header>

  <div class="wrap">
    <div class="card">
      <div class="row">
        <div>
          <label>Symbols (comma-separated)</label>
          <input id="symbols" placeholder="e.g., SPY,QQQ,AAPL,MSFT" value="SPY,QQQ" />
        </div>
        <div>
          <label>Horizon (days)</label>
          <input id="horizon" type="number" min="1" max="14" value="5" />
        </div>
        <div style="display:flex; gap:8px;">
          <button class="primary" id="run">Compare</button>
          <button class="ghost" id="copy">Copy API Link</button>
        </div>
      </div>
      <div class="hr"></div>
      <div id="status" class="muted">Ready.</div>
    </div>

    <div class="card" style="margin-top:16px;">
      <table id="tbl">
        <thead>
          <tr>
            <th data-key="symbol">Symbol</th>
            <th data-key="probability_up">Prob â†‘</th>
            <th data-key="momentum_7bar_pct">7-bar Mom</th>
            <th data-key="sentiment">Sentiment</th>
            <th data-key="trend">Trend</th>
            <th data-key="rsi">RSI</th>
            <th data-key="volatility">Volatility</th>
            <th data-key="rationale">Rationale</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div id="note" class="muted" style="margin-top:10px;"></div>
    </div>

    <div id="failBox" class="card hidden" style="margin-top:16px;">
      <div style="font-weight:700; margin-bottom:6px;">Failures</div>
      <div id="failList" class="mono muted">â€”</div>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);
    const fmtPct = (x) => (x == null || isNaN(x)) ? "â€”" : (Number(x) * 100).toFixed(0) + "%";
    const fmtPct2 = (x) => (x == null || isNaN(x)) ? "â€”" : Number(x).toFixed(2) + "%";
    const toTrend = (rsi, sma50, sma200) => {
      if (sma50 == null || sma200 == null) return "â€”";
      if (sma50 > sma200) return "up";
      if (sma50 < sma200) return "down";
      return "flat";
    };

    function buildRow(r) {
      const tr = document.createElement("tr");
      const trend = toTrend(r.signals?.rsi, r.signals?.sma50, r.signals?.sma200);
      tr.innerHTML = `
        <td><a href="/scorecard.html?symbol=${encodeURIComponent(r.symbol)}" style="color:#e7ecf5; text-decoration:none;">${r.symbol}</a></td>
        <td>${fmtPct(r.probability_up)}</td>
        <td>${fmtPct2(r.momentum_7bar_pct)}</td>
        <td>${r.sentiment == null ? "â€”" : Number(r.sentiment).toFixed(3)}</td>
        <td>${trend}</td>
        <td>${r.signals?.rsi == null ? "â€”" : Math.round(r.signals.rsi)}</td>
        <td>${r.volatility ?? "â€”"}</td>
        <td class="muted">${Array.isArray(r.rationale) ? r.rationale.slice(0,3).join("; ") : "â€”"}</td>
      `;
      return tr;
    }

    function sortBy(tbody, key, dir=1) {
      const rows = Array.from(tbody.querySelectorAll("tr"));
      rows.sort((a,b) => {
        const get = (tr) => {
          const cells = tr.children;
          switch (key) {
            case "symbol": return cells[0].textContent.trim();
            case "probability_up": return parseFloat((cells[1].textContent || "").replace("%","")) || -1e9;
            case "momentum_7bar_pct": return parseFloat((cells[2].textContent || "").replace("%","")) || -1e9;
            case "sentiment": return parseFloat(cells[3].textContent) || -1e9;
            case "trend": return cells[4].textContent;
            case "rsi": return parseFloat(cells[5].textContent) || -1e9;
            case "volatility": return {high:2,normal:1,low:0}[cells[6].textContent] ?? 3;
            default: return 0;
          }
        };
        const va = get(a), vb = get(b);
        if (typeof va === "string" && typeof vb === "string") return dir * va.localeCompare(vb);
        return dir * ((va > vb) - (va < vb));
      });
      rows.forEach(r => tbody.appendChild(r));
    }

    async function run() {
      const symbols = $("symbols").value.split(",").map(s => s.trim().toUpperCase()).filter(Boolean);
      const horizon = Number($("horizon").value || 5);
      if (!symbols.length) { alert("Enter at least one symbol"); return; }

      $("status").textContent = "Comparingâ€¦";
      const u = `${location.origin}/api/compare_proxy?symbols=${encodeURIComponent(symbols.join(","))}&horizon_days=${horizon}`;
      const r = await fetch(u, { cache:"no-store" });
      const data = await r.json().catch(() => null);
      $("status").textContent = r.ok ? "Done." : `Error: ${r.status}`;

      const tbody = $("tbl").querySelector("tbody");
      tbody.innerHTML = "";

      if (!r.ok || !data || data.ok !== true) {
        $("note").textContent = (data && data.error) ? data.error : "Request failed";
        $("failBox").classList.add("hidden");
        return;
      }

      (data.results || []).forEach(item => tbody.appendChild(buildRow(item)));
      $("note").textContent = `Sorted by probability. Horizon ${horizon} days.`;

      if (data.failures && data.failures.length) {
        $("failBox").classList.remove("hidden");
        $("failList").textContent = JSON.stringify(data.failures, null, 2);
      } else {
        $("failBox").classList.add("hidden");
      }
    }

    // Sort handlers
    (function initSort(){
      const thead = $("tbl").querySelector("thead");
      let lastKey = "probability_up", dir = -1;
      thead.addEventListener("click", (e) => {
        const th = e.target.closest("th");
        if (!th) return;
        const key = th.dataset.key;
        if (!key) return;
        const tbody = $("tbl").querySelector("tbody");
        dir = (key === lastKey) ? -dir : -1; // default desc
        lastKey = key;
        sortBy(tbody, key, dir);
      });
    })();

    $("run").addEventListener("click", run);
    $("copy").addEventListener("click", () => {
      const syms = $("symbols").value.trim() || "SPY,QQQ";
      const horizon = Number($("horizon").value || 5);
      const link = `${location.origin}/api/compare_proxy?symbols=${encodeURIComponent(syms)}&horizon_days=${horizon}`;
      navigator.clipboard.writeText(link).then(() => $("status").textContent = "Copied shareable API link.");
    });

    // Auto-run if ?symbols=
    (function initFromQuery(){
      const q = new URLSearchParams(location.search);
      if (q.get("symbols")) $("symbols").value = q.get("symbols");
      if (q.get("horizon_days")) $("horizon").value = q.get("horizon_days");
      run();
    })();
  </script>
</body>
</html>
