{
  "openapi": "3.1.0",
  "info": {
    "title": "Market Watch Backend (Public Read API)",
    "version": "1.7.0",
    "description": "Read-only endpoints for probability, technicals, scorecards, portfolio insights, expected return, CSV exports, live data proxies, trusted news + sentiment, health checks, and a single-call 'why is it moving?' endpoint."
  },
  "servers": [
    { "url": "https://market-watch-backend.vercel.app" }
  ],
  "paths": {
    "/api/prob": {
      "get": {
        "operationId": "getProbability",
        "summary": "Short-term upside probability for a symbol",
        "parameters": [
          { "name": "symbol", "in": "query", "required": true, "schema": { "type": "string", "example": "AAPL" } },
          { "name": "horizon_days", "in": "query", "required": false, "schema": { "type": "integer", "default": 5, "minimum": 1, "maximum": 14 } }
        ],
        "responses": {
          "200": { "description": "OK", "content": { "application/json": { "schema": { "type": "object" } } } }
        }
      }
    },
    "/api/tech": {
      "get": {
        "operationId": "getTechnicals",
        "summary": "Latest technicals snapshot for a symbol",
        "parameters": [
          { "name": "symbol", "in": "query", "required": true, "schema": { "type": "string", "example": "AAPL" } }
        ],
        "responses": {
          "200": { "description": "OK", "content": { "application/json": { "schema": { "type": "object" } } } }
        }
      }
    },
    "/api/scorecard_proxy": {
      "get": {
        "operationId": "getScorecard",
        "summary": "Aggregate signals (probability, technicals, options, institutional)",
        "parameters": [
          { "name": "symbol", "in": "query", "required": true, "schema": { "type": "string", "example": "AAPL" } },
          { "name": "hours", "in": "query", "required": false, "schema": { "type": "integer", "default": 72 } },
          { "name": "horizon_days", "in": "query", "required": false, "schema": { "type": "integer", "default": 5 } }
        ],
        "responses": {
          "200": { "description": "OK", "content": { "application/json": { "schema": { "type": "object" } } } }
        }
      }
    },
    "/api/scorecard_plus_proxy": {
      "get": {
        "operationId": "getScorecardPlus",
        "summary": "Scorecard + Expected Return (adds drift/vol interval)",
        "parameters": [
          { "name": "symbol", "in": "query", "required": true, "schema": { "type": "string", "example": "AAPL" } },
          { "name": "hours", "in": "query", "required": false, "schema": { "type": "integer", "default": 72 } },
          { "name": "horizon_days", "in": "query", "required": false, "schema": { "type": "integer", "default": 5 } },
          { "name": "lookback_days", "in": "query", "required": false, "schema": { "type": "integer", "default": 90 } }
        ],
        "responses": {
          "200": { "description": "OK", "content": { "application/json": { "schema": { "type": "object" } } } }
        }
      }
    },
    "/api/compare_proxy": {
      "get": {
        "operationId": "compareSymbols",
        "summary": "Compare tickers by probability, momentum, sentiment, volatility",
        "parameters": [
          { "name": "symbols", "in": "query", "required": true, "schema": { "type": "string", "example": "SPY,QQQ,AAPL,MSFT" } },
          { "name": "horizon_days", "in": "query", "required": false, "schema": { "type": "integer", "default": 5 } }
        ],
        "responses": {
          "200": { "description": "OK", "content": { "application/json": { "schema": { "type": "object" } } } }
        }
      }
    },
    "/api/options_signal_link": {
      "get": {
        "operationId": "getOptionsTilt",
        "summary": "Options activity tilt (bullish/neutral/bearish)",
        "parameters": [
          { "name": "symbol", "in": "query", "required": true, "schema": { "type": "string", "example": "AAPL" } },
          { "name": "fallback_days", "in": "query", "required": false, "schema": { "type": "integer", "default": 7 } }
        ],
        "responses": {
          "200": { "description": "OK", "content": { "application/json": { "schema": { "type": "object" } } } }
        }
      }
    },
    "/api/institutional_signal_link": {
      "get": {
        "operationId": "getInstitutionalTilt",
        "summary": "Institutional flow tilt (bullish/neutral/bearish)",
        "parameters": [
          { "name": "symbol", "in": "query", "required": true, "schema": { "type": "string", "example": "AAPL" } },
          { "name": "fallback_days", "in": "query", "required": false, "schema": { "type": "integer", "default": 10 } }
        ],
        "responses": {
          "200": { "description": "OK", "content": { "application/json": { "schema": { "type": "object" } } } }
        }
      }
    },
    "/api/expected_return": {
      "get": {
        "operationId": "getExpectedReturn",
        "summary": "Expected return estimate with 68% interval (log-return drift/vol)",
        "parameters": [
          { "name": "symbol", "in": "query", "required": true, "schema": { "type": "string", "example": "AAPL" } },
          { "name": "horizon_days", "in": "query", "required": false, "schema": { "type": "integer", "default": 7 } },
          { "name": "lookback_days", "in": "query", "required": false, "schema": { "type": "integer", "default": 90 } }
        ],
        "responses": {
          "200": { "description": "OK", "content": { "application/json": { "schema": { "type": "object" } } } }
        }
      }
    },
    "/api/prompt_template": {
      "get": {
        "operationId": "getPromptTemplate",
        "summary": "Build a GPT-ready single-ticker prompt",
        "parameters": [
          { "name": "symbol", "in": "query", "required": true, "schema": { "type": "string", "example": "AAPL" } },
          { "name": "hours", "in": "query", "required": false, "schema": { "type": "integer", "default": 72 } },
          { "name": "horizon_days", "in": "query", "required": false, "schema": { "type": "integer", "default": 5 } }
        ],
        "responses": {
          "200": { "description": "OK", "content": { "application/json": { "schema": { "type": "object" } } } }
        }
      }
    },
    "/api/action_portfolio_list": {
      "get": {
        "operationId": "actionPortfolioList",
        "summary": "List portfolio holdings (server-injected token)",
        "parameters": [
          { "name": "user", "in": "query", "required": true, "schema": { "type": "string", "example": "7e4b9c4b-9af2-4d8e-9b9b-1d3e2a6f0f11" } }
        ],
        "responses": {
          "200": { "description": "OK", "content": { "application/json": { "schema": { "type": "object" } } } }
        }
      }
    },
    "/api/action_portfolio_insights": {
      "get": {
        "operationId": "actionPortfolioInsights",
        "summary": "Portfolio insights (server-injected token)",
        "parameters": [
          { "name": "user", "in": "query", "required": true, "schema": { "type": "string", "format": "uuid", "example": "7e4b9c4b-9af2-4d8e-9b9b-1d3e2a6f0f11" } },
          { "name": "hours", "in": "query", "required": false, "schema": { "type": "integer", "default": 72 } }
        ],
        "responses": {
          "200": { "description": "OK", "content": { "application/json": { "schema": { "type": "object" } } } }
        }
      }
    },
    "/api/export_compare_csv": {
      "get": {
        "operationId": "exportCompareCsv",
        "summary": "Export compare results to CSV",
        "parameters": [
          { "name": "symbols", "in": "query", "required": true, "description": "Comma-separated tickers. Accepts index aliases (e.g., ^GSPC → SPY) and normalizes BRK-B → BRK.B.", "schema": { "type": "string", "example": "SPY,QQQ,AAPL,MSFT" } },
          { "name": "horizon_days", "in": "query", "required": false, "schema": { "type": "integer", "default": 5, "minimum": 1, "maximum": 14 } }
        ],
        "responses": {
          "200": { "description": "OK (CSV)", "content": { "text/csv": { "schema": { "type": "string" } } } }
        }
      }
    },
    "/api/export_portfolio_csv": {
      "get": {
        "operationId": "exportPortfolioCsv",
        "summary": "Export portfolio insights to CSV (server-injected token)",
        "parameters": [
          { "name": "user", "in": "query", "required": true, "schema": { "type": "string", "format": "uuid", "example": "7e4b9c4b-9af2-4d8e-9b9b-1d3e2a6f0f11" } },
          { "name": "hours", "in": "query", "required": false, "schema": { "type": "integer", "default": 72, "minimum": 6, "maximum": 168 } }
        ],
        "responses": {
          "200": { "description": "OK (CSV)", "content": { "text/csv": { "schema": { "type": "string" } } } }
        }
      }
    },
    "/api/quote_proxy": {
      "get": {
        "operationId": "getLiveQuote",
        "summary": "Live quote via server-side provider (Yahoo with Stooq fallback + TTL cache)",
        "parameters": [
          { "name": "symbol", "in": "query", "required": true, "schema": { "type": "string", "example": "AAPL" } },
          { "name": "force", "in": "query", "required": false, "description": "Bypass cache if true.", "schema": { "type": "boolean", "default": false } },
          { "name": "ttl", "in": "query", "required": false, "description": "Cache TTL seconds.", "schema": { "type": "integer", "default": 15, "minimum": 1, "maximum": 300 } }
        ],
        "responses": {
          "200": { "description": "OK", "content": { "application/json": { "schema": { "type": "object" } } } }
        }
      }
    },
    "/api/history_proxy": {
      "get": {
        "operationId": "getHistory",
        "summary": "Recent OHLCV via server-side provider (Yahoo → Stooq fallback) with optional upsert to daily_agg and TTL cache",
        "parameters": [
          { "name": "symbol", "in": "query", "required": true, "schema": { "type": "string", "example": "AAPL" } },
          { "name": "range", "in": "query", "required": false, "schema": { "type": "string", "enum": ["5d","1mo","3mo","6mo","1y","2y"], "default": "6mo" } },
          { "name": "interval", "in": "query", "required": false, "schema": { "type": "string", "enum": ["1d","1wk"], "default": "1d" } },
          { "name": "upsert", "in": "query", "required": false, "description": "If true (and interval=1d), writes rows into daily_agg (requires token).", "schema": { "type": "boolean", "default": false } },
          { "name": "token", "in": "query", "required": false, "description": "Required when upsert=true. Use WRITER_BEARER_TOKEN.", "schema": { "type": "string" } },
          { "name": "force", "in": "query", "required": false, "description": "Bypass cache if true.", "schema": { "type": "boolean", "default": false } },
          { "name": "ttl", "in": "query", "required": false, "description": "Cache TTL seconds (default 6h; 1wk interval defaults to 1h).", "schema": { "type": "integer", "minimum": 60, "maximum": 604800, "default": 21600 } }
        ],
        "responses": {
          "200": { "description": "OK", "content": { "application/json": { "schema": { "type": "object" } } } }
        }
      }
    },
    "/api/news_proxy": {
      "get": {
        "operationId": "getNews",
        "summary": "Trusted headlines for a symbol (Reuters/AP/WSJ/FT/CNBC via providers)",
        "parameters": [
          { "name": "symbol", "in": "query", "required": true, "schema": { "type": "string", "example": "AAPL" } },
          { "name": "hours", "in": "query", "required": false, "schema": { "type": "integer", "default": 72 } },
          { "name": "limit", "in": "query", "required": false, "schema": { "type": "integer", "default": 25 } },
          { "name": "force", "in": "query", "required": false, "schema": { "type": "boolean", "default": false } },
          { "name": "ttl", "in": "query", "required": false, "schema": { "type": "integer", "default": 300 } }
        ],
        "responses": {
          "200": { "description": "OK", "content": { "application/json": { "schema": { "type": "object" } } } }
        }
      }
    },
    "/api/news_sentiment": {
      "get": {
        "operationId": "getNewsSentiment",
        "summary": "Aggregate news sentiment for a symbol (last N hours)",
        "parameters": [
          { "name": "symbol", "in": "query", "required": true, "schema": { "type": "string", "example": "AAPL" } },
          { "name": "hours", "in": "query", "required": false, "schema": { "type": "integer", "default": 72 } }
        ],
        "responses": {
          "200": { "description": "OK", "content": { "application/json": { "schema": { "type": "object" } } } }
        }
      }
    },
    "/api/why_proxy": {
      "get": {
        "operationId": "getWhy",
        "summary": "Explain current move: price vs prior close, probability, expected return, news sentiment, headlines",
        "parameters": [
          { "name": "symbol", "in": "query", "required": true, "schema": { "type": "string", "example": "AAPL" } },
          { "name": "hours", "in": "query", "required": false, "schema": { "type": "integer", "default": 72 } },
          { "name": "horizon_days", "in": "query", "required": false, "schema": { "type": "integer", "default": 5 } }
        ],
        "responses": {
          "200": { "description": "OK", "content": { "application/json": { "schema": { "type": "object" } } } }
        }
      }
    },
    "/api/health": {
      "get": {
        "operationId": "getHealth",
        "summary": "Service health (shallow + deep checks)",
        "parameters": [
          { "name": "deep", "in": "query", "required": false, "description": "If true, calls internal quote/history endpoints.", "schema": { "type": "boolean", "default": false } },
          { "name": "secret", "in": "query", "required": false, "description": "Required when deep=true (HEALTH_SECRET).", "schema": { "type": "string" } }
        ],
        "responses": {
          "200": { "description": "OK / Healthy", "content": { "application/json": { "schema": { "type": "object" } } } },
          "503": { "description": "Unhealthy", "content": { "application/json": { "schema": { "type": "object" } } } }
        }
      }
    },
    "/api/healthz": {
      "get": {
        "operationId": "getUptime",
        "summary": "Cheap uptime probe (‘ok’ text)",
        "responses": {
          "200": { "description": "OK (text)", "content": { "text/plain": { "schema": { "type": "string" } } } }
        }
      }
    }
  }
}
