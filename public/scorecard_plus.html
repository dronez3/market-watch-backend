<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Market Watch â€” Scorecard Plus</title>
  <style>
    :root { --bg:#0b1020; --card:#151b2e; --text:#e7ecf5; --muted:#9fb0d1; --accent:#5ee6a8; --warn:#ffc65c; --bad:#ff7a7a; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; background: var(--bg); color: var(--text); }
    header { padding: 20px 16px; border-bottom: 1px solid #20263f; background: #0e1430; position: sticky; top:0; z-index: 10; }
    h1 { margin:0; font-size: 20px; letter-spacing: .3px; }
    .wrap { max-width: 980px; margin: 0 auto; padding: 20px 16px; }
    .card { background: var(--card); border: 1px solid #232a44; border-radius: 14px; padding: 16px; box-shadow: 0 6px 24px rgba(0,0,0,.25); }
    .row { display: grid; grid-template-columns: 1fr 120px 120px 140px; gap: 12px; }
    label { font-size: 12px; color: var(--muted); display:block; margin-bottom: 6px; }
    input, button { width:100%; padding: 10px 12px; border-radius: 10px; border: 1px solid #2a3356; background: #0f1533; color: var(--text); }
    button { cursor: pointer; border-color:#38406b; font-weight: 600; }
    button.primary { background: linear-gradient(180deg,#2cd4ff,#6cf3c5); color: #0a0f22; border: none; }
    .grid { display:grid; gap:12px; }
    .kpi { display:grid; gap:6px; padding:10px; background:#101737; border:1px solid #263059; border-radius:12px; }
    .kpi .label { font-size:12px; color:var(--muted); }
    .kpi .value { font-size:18px; font-weight:700; }
    .pill { display:inline-flex; align-items:center; padding: 4px 8px; border-radius: 999px; font-size: 12px; border: 1px solid #2a3356; }
    .pill.ok { background: rgba(94,230,168,.12); border-color: rgba(94,230,168,.4); color: var(--accent); }
    .pill.warn { background: rgba(255,198,92,.12); border-color: rgba(255,198,92,.4); color: var(--warn); }
    .pill.bad { background: rgba(255,122,122,.12); border-color: rgba(255,122,122,.4); color: var(--bad); }
    .muted { color: var(--muted); }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
    .hr { height:1px; background:#222a48; margin:12px 0; }
    .hidden { display:none; }
    @media (max-width: 860px) { .row { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <header>
    <div class="wrap" style="display:flex; align-items:center; gap:10px; justify-content:space-between;">
      <h1>ðŸ“ˆ Market Watch â€” Scorecard Plus</h1>
      <div style="display:flex; gap:8px;">
        <a class="pill muted" href="/scorecard.html" style="text-decoration:none;">Scorecard</a>
        <a class="pill muted" href="/compare.html" style="text-decoration:none;">Compare</a>
        <a class="pill muted" href="/portfolio.html" style="text-decoration:none;">Portfolio</a>
      </div>
    </div>
  </header>

  <div class="wrap">
    <div class="card grid">
      <div class="row">
        <div>
          <label>Symbol</label>
          <input id="symbol" placeholder="e.g., AAPL" value="AAPL" />
        </div>
        <div>
          <label>Horizon (days)</label>
          <input id="horizon" type="number" min="1" max="14" value="5" />
        </div>
        <div>
          <label>Window (hours) for sentiment</label>
          <input id="hours" type="number" min="6" max="168" value="72" />
        </div>
        <div>
          <label>Lookback (days) for expected return</label>
          <input id="lookback" type="number" min="20" max="250" value="90" />
        </div>
      </div>
      <div style="display:flex; gap:8px;">
        <button class="primary" id="run">Run Scorecard Plus</button>
        <button id="copyLink">Copy API Link</button>
      </div>
      <div id="status" class="muted">Ready.</div>
    </div>

    <div id="result" class="grid hidden" style="margin-top:16px;">
      <div class="card grid">
        <div style="font-size:16px; font-weight:700;" id="headline">â€”</div>
        <div class="muted" id="analysis">â€”</div>
        <div class="hr"></div>
        <div class="row">
          <div class="kpi"><div class="label">Prob (base)</div><div class="value" id="pBase">â€”</div></div>
          <div class="kpi"><div class="label">Prob (blended)</div><div class="value" id="pBlend">â€”</div></div>
          <div class="kpi"><div class="label">Exp. Return (~H)</div><div class="value" id="er">â€”</div></div>
          <div class="kpi"><div class="label">68% Interval</div><div class="value" id="erBand">â€”</div></div>
          <div class="kpi"><div class="label">Confidence</div><div class="value" id="erConf">â€”</div></div>
        </div>
      </div>

      <div class="card grid">
        <div style="display:flex; align-items:center; justify-content:space-between;">
          <div style="font-weight:700;">Technicals & Flows</div>
          <div style="display:flex; gap:8px;">
            <span id="techPill" class="pill">Tech â€”</span>
            <span id="optPill" class="pill">Options â€”</span>
            <span id="instPill" class="pill">Institutional â€”</span>
          </div>
        </div>
        <div class="row">
          <div class="kpi"><div class="label">RSI</div><div class="value" id="rsi">â€”</div></div>
          <div class="kpi"><div class="label">SMA50</div><div class="value" id="sma50">â€”</div></div>
          <div class="kpi"><div class="label">SMA200</div><div class="value" id="sma200">â€”</div></div>
          <div class="kpi"><div class="label">7-bar Momentum</div><div class="value" id="mom7">â€”</div></div>
        </div>
        <div class="muted mono" id="notes"></div>
      </div>

      <div class="card">
        <div style="font-weight:700; margin-bottom:6px;">Debug</div>
        <pre id="debug" class="mono muted" style="margin:0; white-space:pre-wrap; word-break:break-word;">â€”</pre>
      </div>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);
    const pct = (x) => (x == null || isNaN(x)) ? "â€”" : (Number(x) * 100).toFixed(0) + "%";
    const pct2 = (x) => (x == null || isNaN(x)) ? "â€”" : Number(x).toFixed(2) + "%";

    function setPill(el, label, kind="") {
      el.textContent = label;
      el.classList.remove("ok","warn","bad");
      if (kind) el.classList.add(kind);
    }

    async function run() {
      const sym = $("symbol").value.trim().toUpperCase();
      const horizon = Number($("horizon").value || 5);
      const hours = Number($("hours").value || 72);
      const lookback = Number($("lookback").value || 90);
      if (!sym) { alert("Enter a symbol"); return; }

      $("status").textContent = "Runningâ€¦";
      $("result").classList.add("hidden");

      const u = `${location.origin}/api/scorecard_plus_proxy?symbol=${encodeURIComponent(sym)}&horizon_days=${horizon}&hours=${hours}&lookback_days=${lookback}`;
      const r = await fetch(u, { cache:"no-store" });
      const data = await r.json().catch(()=>null);
      $("debug").textContent = JSON.stringify(data, null, 2);

      if (!r.ok || !data || data.ok !== true) {
        $("status").textContent = `Error: ${r.status}`;
        $("result").classList.remove("hidden");
        $("headline").textContent = `${sym} â€” error`;
        $("analysis").textContent = (data && data.error) ? data.error : "Request failed";
        return;
      }

      $("status").textContent = "Done.";
      $("result").classList.remove("hidden");

      $("headline").textContent = `${sym} â€” ${(data.probability_blended*100).toFixed(0)}% Upside (Blended)`;
      $("analysis").textContent = data.analysis || "â€”";

      $("pBase").textContent = pct(data.probability_base);
      $("pBlend").textContent = pct(data.probability_blended);

      if (data.expected_return && data.expected_return.available !== false) {
        $("er").textContent = pct2(data.expected_return.pct);
        const band = data.expected_return.conf68;
        $("erBand").textContent = (band && band.low != null && band.high != null)
          ? `${pct2(band.low)} .. ${pct2(band.high)}`
          : "â€”";
        $("erConf").textContent = data.expected_return.confidence != null
          ? (Number(data.expected_return.confidence) * 100).toFixed(0) + "%"
          : "â€”";
      } else {
        $("er").textContent = "â€”";
        $("erBand").textContent = "â€”";
        $("erConf").textContent = "â€”";
      }

      const rsi = data.technicals?.rsi ?? null;
      const sma50 = data.technicals?.sma50 ?? null;
      const sma200 = data.technicals?.sma200 ?? null;
      $("rsi").textContent = rsi == null ? "â€”" : Math.round(rsi);
      $("sma50").textContent = sma50 == null ? "â€”" : Math.round(sma50);
      $("sma200").textContent = sma200 == null ? "â€”" : Math.round(sma200);

      const trend = (sma50 != null && sma200 != null) ? (sma50 > sma200 ? "uptrend" : sma50 < sma200 ? "downtrend" : "neutral") : "missing";
      if (trend === "uptrend") setPill($("techPill"), "Tech â€” uptrend", "ok");
      else if (trend === "downtrend") setPill($("techPill"), "Tech â€” downtrend", "bad");
      else setPill($("techPill"), "Tech â€” missing/neutral", "warn");

      const mom7 = data.momentum_7bar_pct;
      $("mom7").textContent = mom7 == null ? "â€”" : Number(mom7).toFixed(2) + "%";

      const opt = data.components?.options?.data;
      if (opt && opt.ok && opt.found !== false) {
        setPill($("optPill"), `Options ${opt.label}`, opt.label === "bullish" ? "ok" : opt.label === "bearish" ? "bad" : "warn");
      } else setPill($("optPill"), "Options â€” n/a", "warn");

      const inst = data.components?.institutional?.data;
      if (inst && inst.ok && inst.found !== false) {
        setPill($("instPill"), `Institutional ${inst.label}`, inst.label === "bullish" ? "ok" : inst.label === "bearish" ? "bad" : "warn");
      } else setPill($("instPill"), "Institutional â€” n/a", "warn");

      $("notes").textContent = `RSI ${$("rsi").textContent} â€¢ SMA50 ${$("sma50").textContent} vs SMA200 ${$("sma200").textContent} â€¢ 7-bar momentum ${$("mom7").textContent}`;
    }

    $("run").addEventListener("click", run);
    $("copyLink").addEventListener("click", () => {
      const sym = $("symbol").value.trim().toUpperCase() || "AAPL";
      const horizon = Number($("horizon").value || 5);
      const hours = Number($("hours").value || 72);
      const lookback = Number($("lookback").value || 90);
      const link = `${location.origin}/api/scorecard_plus_proxy?symbol=${encodeURIComponent(sym)}&horizon_days=${horizon}&hours=${hours}&lookback_days=${lookback}`;
      navigator.clipboard.writeText(link).then(() => $("status").textContent = "Copied API link.");
    });

    // Auto-run if query present
    (function initFromQuery(){
      const q = new URLSearchParams(location.search);
      const sym = (q.get("symbol") || "").toUpperCase();
      if (sym) {
        $("symbol").value = sym;
        if (q.get("horizon_days")) $("horizon").value = q.get("horizon_days");
        if (q.get("hours")) $("hours").value = q.get("hours");
        if (q.get("lookback_days")) $("lookback").value = q.get("lookback_days");
        run();
      }
    })();
  </script>
</body>
</html>
